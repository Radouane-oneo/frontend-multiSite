<?php

use \printconnect\Newsletters\Subscriptions\Factory;
use \printconnect\Customers;

function pcnewsletters_menu() {
  $items['newsletter'] = array(
      'title' => 'Newsletter',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('pcnewsletters_subscribe_form'),
      'access arguments' => array('access content'),
          //'file' => 'pcnewsletters.forms.inc',
  );
  $items['newsletter/subscribe'] = array(
      'title' => 'Subscribe',
      'access arguments' => array('access content'),
  );
  $items['newsletter/unsubscribe'] = array(
      'title' => 'Unsubscribe',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('pcnewsletters_unsubscribe_form'),
      'access arguments' => array('access content'),
          // 'file' => 'pcnewsletters.forms.inc',
  );
  return $items;
}

/*
  function pcnewsletters_block_info() {
  $blocks['subscribe'] = array(
  'info' => t('Newsletter subscribe'),
  );
  return $blocks;
  }

  function pcnewsletters_block_view($delta = '') {
  module_load_include('inc', 'pcnewsletters', 'pcnewsletters.forms');
  $block['title'] = t('Subscribe');
  $block['content'] = drupal_get_form('pcnewsletters_subscribe_form');
  return $block;
  }
 */

function pcnewsletters_form_pccheckout_checkout_form_alter(&$form, $form_state, $form_id) {
  if (isset($form['personal'])) {
    /* $form['personal']['subscribe'] = array(
      '#type' => 'checkbox',
      '#title' => t('Subscribe to newsletter'),
      );
      array_unshift($form['personal']['submit']['#submit'], 'pcnewsletters_form_pccheckout_form_submit');
     */
  }
}

function pcnewsletters_form_pccheckout_form_submit($form, &$form_state) {
  if (isset($form_state['values']['personal']['subscribe'])) {
    $customer = Customers\Factory::Current();
    if ($customer) {
      /* $subscription = Factory::GetByEmail($customer->email);
        if (!$subscription) {
        $subscription = Factory::Create($customer->email);
        Factory::Save($subscription);
        } */
    }
    //  drupal_set_message(t('Subscribed'));
  }
}

function pcnewsletters_subscribe_form($form, $form_state) {
  $customer = \printconnect\Customers\Factory::Current();
  $email = '';

  if ($customer) {
    $email = $customer->email;
  }

  if (!isset($form_state['storage']['subscribed'])) {

    $form['text'] = array(
        '#type' => 'container',
        '#attributes' => array('class' => array('text')),
        'content' => array(
            '#prefix' => '<p>',
            '#markup' => t('Do you want to learn more about what printconnect.com can do for you?'),
            '#suffix' => '</p>',
        ),
    );

    $form['email'] = array(
        '#type' => 'textfield',
        '#title' => t('Email'),
        '#default_value' => $email,
        '#description' => t('Email'),
        '#required' => TRUE,
        '#attributes' => array('class' => array('hint')),
    );
    $form['actions']['submit'] = array(
        '#type' => 'submit',
        '#value' => t('Subscribe'),
        '#ajax' => array(
            'callback' => 'pcnewsletters_subscribe_form_callback',
            'wrapper' => 'pcnewsletters-subscribe-form',
            'method' => 'replace',
            'effect' => 'fade',
            'progress' => array(
                'message' => NULL,
                'type' => NULL,
            ),
        )
    );
  } else {
    $form['confirmation'] = array(
        '#type' => 'container',
        '#attributes' => array('class' => array('confirmation')),
        'content' => array(
            '#markup' => '<p>' . t('Thank you very much for subscribing. Twice a month, you’ll receive the latest promotions and news. Don’t miss out!') . '</p><div class="icone-newsletter"></div><p>Vous avez reçu votre email de bienvenue.</p>',
        ),
    );
  }

  $form['#id'] = 'pcnewsletters-subscribe-form';

  return $form;
}

function pcnewsletters_subscribe_form_submit($form, &$form_state) {
//  $subscription = Factory::GetByEmail($form_state['values']['email']);
  // $subscription->EnsureLoaded();
//  if (!$subscription) 
    
    
  try {
    $subscription = Factory::Create($form_state['values']['email']);
    Factory::Save($subscription);
    $form_state['storage']['subscribed'] = TRUE;
     
  } catch (\Exception $ex) {
    
  }

  $form_state['rebuild'] = TRUE;
pcnewsletters_mail_send_client('',$form_state); 
pcnewsletters_mail_send_admin('',$form_state); 
}

function  pcnewsletters_subscribe_form_validate(&$form, &$form_state, $form_id) {
        if (!valid_email_address($form_state['values']['email'])) {
             form_set_error('email', t('You must enter a valid e-mail address.'));
        }
           
}   
function pcnewsletters_subscribe_form_callback($form, $form_state) {
  return $form;
}

function pcnewsletters_unsubscribe_form($form, $form_state) {
  $customer = \printconnect\Customers\Factory::Current();
  $email = '';

  if ($customer) {
    $email = $customer->email;
  }

  $options = array(
      '1' => t('No interest'),
      '2' => t('Too much information'),
  );


  $form['email'] = array(
      '#type' => 'textfield',
      '#title' => t('Email'),
      '#default_value' => $email,
  );

  $form['reason'] = array(
      '#type' => 'radios',
      '#title' => t('Reason'),
      '#options' => $options,
  );

  $form['actions']['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Unsubscribe'),
  );
  return $form;
}

function pcnewsletters_unsubscribe_form_submit($form, $form_state) {
  Factory::Delete($form_state['values']['email']);
  drupal_set_message(t('Unsubscribed'));
}


function pcnewsletters_mail_send_client($form, &$form_state) {
$module = 'pcnewsletters';
$key = 'envoi_email_client';
$to = $form_state['values']['email'];
$from = 'support@flyer.fr';
$params = '<html>
<head>
</head>
<body>
<style>
td{
border:0px;
font-family:Arial, Helvetica, sans-serif;
}
</style>
<table width="618px" border="0px" cellpadding="0" cellspacing="0" style="background-color:#fff;border:0px;width:618px;margin:0px auto;">
<tr>
<td border="0">
<table border="0px" width="100%">
<tr>
<td border="0" width="25px"></td>
<td border="0" height="85"><img src="http://d4e7wxbvl20c1.cloudfront.net/images.flyer.fr/emailling/logo.png" border="0" /></td><td border="0" align="right"><strong style="color:#76b700;font-size:24px;">Mail de confirmation</strong><br /><span style="color:#646464;font-size:17px">Demande de rappel</span></td><td border="0" width="25px"></td>
</tr>
</table>
</td>
</tr>
<tr >
<td border="0"  >
<table valign="top" width="620" border="0px" align="center" cellpadding="0" cellspacing="0">
<tr>
<td border="0" >
<a style="text-decoration:none;" target="_blank" href="http://flyer.fr/frfr/"><img width="140" height="49" style="display:block;border:0;" border="0" src="http://d4e7wxbvl20c1.cloudfront.net/images.flyer.fr/emailling/home.jpg"></a>
</td>
<td border="0" >
<a style="text-decoration:none;" target="_blank" href="http://flyer.fr/frfr/nos-produits"><img width="154" height="49" style="display:block;border:0;" border="0" src="http://d4e7wxbvl20c1.cloudfront.net/images.flyer.fr/emailling/nosprod.jpg"></a>
</td>
<td border="0" >
<a style="text-decoration:none;" target="_blank" href="http://flyer.fr/frfr/créations-en-ligne"><img width="146" height="49" style="display:block;border:0;" border="0" src="http://d4e7wxbvl20c1.cloudfront.net/images.flyer.fr/emailling/nosmodel.jpg"></a>
</td>
<td border="0" >
<a style="text-decoration:none;" target="_blank" href="http://flyer.fr/frfr/bonneaffaire"><img width="181" height="49" style="display:block;border:0;" border="0" src="http://d4e7wxbvl20c1.cloudfront.net/images.flyer.fr/emailling/bonneaffaire.jpg"></a>
</td> 
</tr>
</table>
</td>
</tr> 
<tr height="15px">
<td border="0"  >&nbsp;</td>
</tr> 
<tr>
<td border="0"  style="">
<table style="border:0px;" valign="top" width="620" border="0px" align="center" cellpadding="0" cellspacing="0">
<tbody>
<tr>
<td border="0"  height="15" width="30px"></td>
<td border="0" >
<font style="font-family:Helvetica,arial;font-size:16px;color:#646464;line-height:18px;"><strong>
Nous vous remercions de l\'intérêt que vous portez à Flyer.fr et de votre inscription à notre newsletter.</strong></font>
</td>
<td border="0" ></td> 
</tr>
<tr height="17px">
<td border="0"  >&nbsp;</td> <td border="0" >&nbsp;</td> <td border="0" >&nbsp;</td>
</tr>
<tr>
<td border="0"  width="14"></td>
<td border="0"  style="font-family:Helvetica,arial;font-size:15px;color:#646464;line-height:18px;">À partir d\'aujourd\'hui, vous pourrez recevoir nos offres et découvrir toutes  les<br /> nouveautés sur notre activité et nos produits.</td>
<td border="0"  width="15"></td> 
</tr>
<tr>
<tr height="15px">
<td border="0"  >&nbsp;</td> <td border="0" >&nbsp;</td> <td border="0" >&nbsp;</td>
</tr>
</tbody></table> 
</td>
</tr>
<tr>
<td border="0"  align="center">
<table align="center" width="100%" border="0px" style="border:0px;">
<tr>
<td border="0"  width="51%" height="322" align="center"><a style="text-decoration:none;" target="_blank" href="http://flyer.fr/frfr/flyerfr-vous-chouchoute"><img src="http://d4e7wxbvl20c1.cloudfront.net/images.flyer.fr/emailling/im1.jpg" /></a></td>
<td border="0"  align="center" width="48%"><a style="text-decoration:none;" target="_blank" href="http://flyer.fr/frfr/bonneaffaire"><img src="http://d4e7wxbvl20c1.cloudfront.net/images.flyer.fr/emailling/im2.jpg" /></a></td>
</tr>
<tr>
<td border="0"  align="center"><a style="text-decoration:none;" target="_blank" href="http://flyer.fr/frfr/papier-peint-photo-personnalisé"><img src="http://d4e7wxbvl20c1.cloudfront.net/images.flyer.fr/emailling/im3.jpg" /></a></td>
<td border="0"  align="center"><a style="text-decoration:none;" target="_blank" href="http://flyer.fr/frfr/créations-en-ligne"><img src="http://d4e7wxbvl20c1.cloudfront.net/images.flyer.fr/emailling/im4.jpg" /></a></td>
</tr>
<tr height="15px">
<td border="0"  >&nbsp;</td> <td border="0" >&nbsp;</td> <td border="0"  width="1%">&nbsp;</td>
</tr> 
</table>
</td>
</tr>
<tr>
<td height="127" border="0" >
<img src="http://d4e7wxbvl20c1.cloudfront.net/images.flyer.fr/emailling/block.jpg" />
</td>
</tr>
<tr>
<td border="0" height="166" align="center"><img src="http://pc-images.s3-eu-west-1.amazonaws.com/images.flyer.fr/emailling/footer.png" /></td>
</tr>
<tr>
<td height="42" border="0" align="center">
<table width="25%" align="center" border="0px">
<tr>
<td border="0"><a href="#"><img src="http://pc-images.s3-eu-west-1.amazonaws.com/images.flyer.fr/emailling/l1.png" /></a></td>
<td border="0"><a href="#"><img src="http://pc-images.s3-eu-west-1.amazonaws.com/images.flyer.fr/emailling/l2.png" /></a></td>
<td border="0"><a href="#"><img src="http://pc-images.s3-eu-west-1.amazonaws.com/images.flyer.fr/emailling/l3.png" /></a></td>
<td border="0"><a href="#"><img src="http://pc-images.s3-eu-west-1.amazonaws.com/images.flyer.fr/emailling/l4.png" /></a></td>
</tr>
</table>
</td>
</tr>
<tr>
	<td height="26" align="center" border="0" style="color:#999999;font-size:12px;">Si vous ne souhaitez plus recevoir ces messages de la part de FLYER.FR, veuillez vous <a href="http://flyer.fr/frfr/newsletter/unsubscribe" style="color:#666666;text-decoration:none;">désabonner</a>.</td>
</tr>
<tr>
	<td align="center" border="0" style="color:#434343;font-size:12px;">© 2014 FLYER.FR | Tous droits réservés.</td>
</tr>
</table>
</body>
</html>';
$language = language_default();
$send = TRUE;
$result = drupal_mail($module, $key, $to, $language, $params, $from, $send );
$sendMeail = FALSE;
if ($result['result'] == TRUE) {
    $sendMeail = TRUE;
}
// mail info insc NL admin
   
}
function pcnewsletters_mail_send_admin($form, &$form_state){
    $module = 'pcnewsletters';
    $key = 'envoi_email_admin';
    $to = 'info@flyer.fr , contact@agenceoneo.com , nabil.b@oneweb.com , bik8yg@gmail.com';
    $from = 'support@flyer.fr';
    $parms = '<table valign="top" width="620" border="0px" align="center" cellpadding="0" cellspacing="0">
                                <tr>
                                  <td border="0"  width="30"></td>
                                  <td border="0" >
                                    <font style="font-family:Helvetica,arial;font-size:16px;color:#646464;line-height:16px;"><strong>
                                      Bonjour,</strong></font>
                                  </td>
                                  <td border="0"  width="15"></td> 
                                </tr>
                                <tr height="17px">
                                <td border="0" >&nbsp;</td> <td border="0" >&nbsp;</td> <td border="0" >&nbsp;</td>
                                 </tr>
                                <tr>
                                  <td border="0"  height="48"></td>
                                  <td border="0" >
                                    <font style="font-family:Helvetica,arial;font-size:14px;color:#646464;line-height:16px;"><strong>
                                        Un nouveau client vient de déposer une incription newsletter sur le site <a style="color:#ff6600;" href="www.flyer.fr/frfr">Flyer.fr</a>.<br> 
                                   </strong></font><br>
                 <font style="font-family:Helvetica,arial;font-size:15px;color:#646464;line-height:16px;">
                                      Détail d\'infos :<br>
                                    </font>
                                 <p><br/><b>' . t('Email') . '</b>: '. $form_state['values']['email'].'<br/></p>
                                </td>
                                  <td border="0" ></td> 
                             </tr>
                                <tr height="17px">
                                <td border="0" >&nbsp;</td> <td border="0" >&nbsp;</td> <td border="0" >&nbsp;</td>
                                 </tr>
                                <tr>
                                  <td border="0"  width="14"></td>
                                  <td border="0" >

                                  </td>
                                  <td border="0"  width="15"></td> 
                                </tr>

                            </table>';
    $language = language_default();
    $send = TRUE;
    $result = drupal_mail($module, $key, $to, $language, $params, $from, $send );
    $sendMeailAdmin = FALSE;
    if ($result['result'] == TRUE) {
        $sendMeailAdmin = TRUE;
    }
}

 function pcnewsletters_mail($key, &$message, $params) {
  switch ($key) {
    case 'envoi_email_client':
          $message['headers']['Content-Type'] = 'text/html; charset=UTF-8; format=flowed';         
          $message['subject'] =  t('Newsletter Flyer.fr');
          $message['body'][] = $params;
        break;
    case 'envoi_email_admin':
          $message['headers']['Content-Type'] = 'text/html; charset=UTF-8; format=flowed';
          $message['subject'] =  t('Newsletter Flyer.fr');
          $message['body'][] = $params;
        break;
  
  }
}